<!DOCTYPE html>
<html lang="ur" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MK Transport Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Updated PDF Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+Urdu:wght@400;700&display=swap');
        body { font-family: sans-serif; -webkit-tap-highlight-color: transparent; background-color: #f8fafc; }
        .urdu { font-family: 'Noto Sans Urdu', serif; }
        .glass { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(12px); border-top: 1px solid rgba(0,0,0,0.05); }
        .tab-content { display: none; animation: fadeIn 0.3s ease; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .card-shadow { box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.05), 0 8px 10px -6px rgba(0, 0, 0, 0.05); }
    </style>
</head>
<body class="text-slate-900 overflow-x-hidden">

    <!-- Auth / PIN Screen -->
    <div id="auth-section" class="fixed inset-0 z-[200] flex flex-col items-center justify-center p-8 bg-slate-900 text-white">
        <div class="bg-blue-600 p-8 rounded-[3rem] mb-6 shadow-2xl">
            <i data-lucide="shield-check" size="64"></i>
        </div>
        <h1 class="text-3xl font-black mb-2 tracking-tighter italic">MK PRO CLOUD</h1>
        <p class="text-slate-400 mb-8 urdu">خفیہ پن کوڈ درج کریں</p>
        <input type="password" id="master-pin" placeholder="PIN" maxlength="4" class="w-64 bg-slate-800 border-2 border-slate-700 rounded-2xl p-5 text-center text-3xl tracking-[1rem] outline-none focus:border-blue-500 text-blue-400 mb-4">
        <button onclick="checkPin()" class="w-64 bg-blue-600 py-4 rounded-2xl font-bold shadow-xl active:scale-95 transition-all urdu">لاگ ان کریں</button>
    </div>

    <!-- Main App -->
    <div id="main-app" class="hidden min-h-screen pb-32">
        <header class="bg-gradient-to-br from-blue-700 to-blue-900 text-white p-6 rounded-b-[3rem] shadow-2xl sticky top-0 z-50">
            <div class="flex justify-between items-center mb-6">
                <div class="flex items-center gap-2">
                    <div class="bg-white/20 p-2 rounded-lg"><i data-lucide="truck" size="20"></i></div>
                    <h1 class="font-black text-xl italic tracking-tighter">MK TRANSPORT</h1>
                </div>
                <button onclick="location.reload()" class="p-2 bg-white/10 rounded-xl hover:bg-white/20"><i data-lucide="refresh-cw" size="20"></i></button>
            </div>
            
            <div class="bg-white text-slate-900 p-6 rounded-[2.5rem] card-shadow relative overflow-hidden">
                <div class="absolute -right-4 -top-4 opacity-5"><i data-lucide="wallet" size="100"></i></div>
                <p class="text-[10px] font-bold text-slate-400 uppercase text-right urdu mb-1">کل خالص منافع (نیٹ پرافٹ)</p>
                <div class="flex items-baseline justify-end gap-1" dir="ltr">
                    <span class="text-sm font-bold text-blue-600">Rs.</span>
                    <span id="total-profit" class="text-4xl font-black text-blue-900">0</span>
                </div>
                <div class="mt-4 pt-4 border-t border-slate-100 grid grid-cols-2 gap-4">
                    <div class="text-right">
                        <p class="text-[8px] text-slate-400 font-bold uppercase">Misbah (50%)</p>
                        <p id="share-m" class="text-sm font-black text-blue-600">Rs. 0</p>
                    </div>
                    <div class="text-right border-r pr-4 border-slate-100">
                        <p class="text-[8px] text-slate-400 font-bold uppercase">Tariq (50%)</p>
                        <p id="share-t" class="text-sm font-black text-blue-600">Rs. 0</p>
                    </div>
                </div>
            </div>
        </header>

        <main class="p-4 max-w-md mx-auto space-y-6">
            <div id="tab-dashboard" class="tab-content active space-y-4">
                <div class="grid grid-cols-2 gap-3">
                    <div class="bg-white p-5 rounded-3xl border border-slate-100 card-shadow">
                        <i data-lucide="fuel" class="text-orange-500 mb-2" size="20"></i>
                        <p class="text-[9px] font-bold text-slate-400 uppercase">Total Diesel</p>
                        <p id="stat-diesel" class="text-lg font-black">0</p>
                    </div>
                    <div class="bg-white p-5 rounded-3xl border border-slate-100 card-shadow">
                        <i data-lucide="utensils" class="text-green-500 mb-2" size="20"></i>
                        <p class="text-[9px] font-bold text-slate-400 uppercase">Total Food</p>
                        <p id="stat-food" class="text-lg font-black">0</p>
                    </div>
                </div>

                <button onclick="downloadPDF()" id="pdf-btn" class="w-full bg-slate-800 text-white p-5 rounded-[2rem] flex items-center justify-center gap-3 font-bold shadow-xl active:scale-95 transition-all">
                    <i data-lucide="file-text"></i>
                    <span class="urdu text-lg">رپورٹ تیار کریں (PDF)</span>
                </button>
                <p class="text-[10px] text-center text-slate-400 urdu">اگر ڈاؤن لوڈ نہ ہو تو فائل نئے ٹیب میں کھلے گی</p>
            </div>

            <!-- Add Trip Tab -->
            <div id="tab-add" class="tab-content space-y-4">
                <form id="trip-form" class="bg-white p-6 rounded-[2.5rem] card-shadow space-y-4">
                    <h2 class="font-black text-slate-800 text-lg urdu text-right flex items-center justify-end gap-2">
                        ٹرپ انٹری <i data-lucide="plus-circle" class="text-blue-600"></i>
                    </h2>
                    <input type="date" id="f-date" class="w-full p-4 bg-slate-50 rounded-2xl outline-none font-bold" required>
                    <input type="text" id="f-route" placeholder="Route (e.g. LHR to KHI)" class="w-full p-4 bg-slate-50 rounded-2xl outline-none font-bold" required>
                    <div class="grid grid-cols-2 gap-3">
                        <input type="number" id="f-income" placeholder="Income" class="w-full p-4 bg-blue-50/50 rounded-2xl font-bold text-blue-700" required>
                        <input type="number" id="f-diesel" placeholder="Diesel" class="w-full p-4 bg-orange-50/50 rounded-2xl font-bold text-orange-700" required>
                    </div>
                    <input type="number" id="f-food" placeholder="Food Expense" class="w-full p-4 bg-green-50/50 rounded-2xl font-bold text-green-700" required>
                    <button type="submit" id="save-btn" class="w-full bg-blue-700 text-white py-5 rounded-2xl font-black shadow-lg">SAVE TRIP</button>
                </form>
            </div>

            <!-- Maintenance Tab -->
            <div id="tab-maintenance" class="tab-content space-y-4">
                <form id="maint-form" class="bg-white p-6 rounded-[2.5rem] card-shadow space-y-4 border-t-4 border-amber-500">
                    <h2 class="font-black text-slate-800 text-lg urdu text-right flex items-center justify-end gap-2">
                        مینٹیننس <i data-lucide="wrench" class="text-amber-600"></i>
                    </h2>
                    <input type="text" id="m-detail" placeholder="Repair Detail" class="w-full p-4 bg-slate-50 rounded-2xl font-bold" required>
                    <input type="number" id="m-amount" placeholder="Amount (Rs)" class="w-full p-4 bg-slate-50 rounded-2xl font-bold text-amber-700" required>
                    <button type="submit" id="m-save-btn" class="w-full bg-amber-600 text-white py-5 rounded-2xl font-black shadow-lg">SAVE</button>
                </form>
                <div id="m-list" class="space-y-3"></div>
            </div>

            <div id="tab-reports" class="tab-content space-y-3">
                <div id="reports-list" class="space-y-3"></div>
            </div>
        </main>

        <nav class="fixed bottom-6 left-6 right-6 glass p-3 rounded-[2.5rem] flex justify-around items-center z-50 shadow-2xl">
            <button onclick="showTab('dashboard')" class="nav-btn p-3 text-blue-600" id="btn-dashboard"><i data-lucide="layout-grid"></i></button>
            <button onclick="showTab('reports')" class="nav-btn p-3 text-slate-400" id="btn-reports"><i data-lucide="history"></i></button>
            <button onclick="showTab('add')" class="p-5 bg-blue-600 text-white rounded-full -mt-16 shadow-xl border-8 border-slate-50"><i data-lucide="plus" size="28"></i></button>
            <button onclick="showTab('maintenance')" class="nav-btn p-3 text-slate-400" id="btn-maintenance"><i data-lucide="wrench"></i></button>
        </nav>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyCJJZ-fhHRf5wasGvWivD7lu0AhS_BHK4A",
            authDomain: "mk-transport-d534f.firebaseapp.com",
            projectId: "mk-transport-d534f",
            storageBucket: "mk-transport-d534f.firebasestorage.app",
            messagingSenderId: "762660902920",
            appId: "1:762660902920:web:1a08f26f67e507a50259bd"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();
        const appId = "mk-transport-pro-v1";
        let tripsData = [];
        let maintData = [];

        lucide.createIcons();
        auth.signInAnonymously();

        function checkPin() {
            if (document.getElementById('master-pin').value === "1234") {
                document.getElementById('auth-section').classList.add('hidden');
                document.getElementById('main-app').classList.remove('hidden');
                loadData();
            } else { alert("Wrong PIN!"); }
        }

        function showTab(id) {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.getElementById('tab-' + id).classList.add('active');
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.replace('text-blue-600', 'text-slate-400'));
            if(id !== 'add') document.getElementById('btn-' + id).classList.replace('text-slate-400', 'text-blue-600');
        }

        document.getElementById('trip-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const payload = {
                date: document.getElementById('f-date').value,
                route: document.getElementById('f-route').value,
                income: parseFloat(document.getElementById('f-income').value) || 0,
                diesel: parseFloat(document.getElementById('f-diesel').value) || 0,
                food: parseFloat(document.getElementById('f-food').value) || 0,
                type: 'trip',
                ts: firebase.firestore.FieldValue.serverTimestamp()
            };
            await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('records').add(payload);
            document.getElementById('trip-form').reset();
            showTab('reports');
        });

        document.getElementById('maint-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const payload = {
                date: new Date().toISOString().split('T')[0],
                detail: document.getElementById('m-detail').value,
                amount: parseFloat(document.getElementById('m-amount').value) || 0,
                type: 'maintenance',
                ts: firebase.firestore.FieldValue.serverTimestamp()
            };
            await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('records').add(payload);
            document.getElementById('maint-form').reset();
        });

        function loadData() {
            db.collection('artifacts').doc(appId).collection('public').doc('data').collection('records')
              .orderBy('ts', 'desc')
              .onSnapshot(snap => {
                  const rList = document.getElementById('reports-list');
                  const mList = document.getElementById('m-list');
                  rList.innerHTML = ""; mList.innerHTML = "";
                  tripsData = []; maintData = [];
                  let totalProfit = 0, totalDiesel = 0, totalFood = 0;

                  snap.forEach(doc => {
                      const d = doc.data(); const id = doc.id;
                      if(d.type === 'trip') {
                          tripsData.push({id, ...d});
                          const p = d.income - (d.diesel + d.food);
                          totalProfit += p; totalDiesel += d.diesel; totalFood += d.food;
                          rList.innerHTML += `<div class="bg-white p-5 rounded-3xl border border-slate-100 card-shadow flex justify-between items-center"><div class="text-right"><p class="font-bold">${d.route}</p><p class="text-[9px] text-slate-400 font-bold">${d.date}</p></div><div class="flex items-center gap-4"><div class="text-left"><p class="font-black text-green-600">Rs. ${p.toLocaleString()}</p></div><button onclick="deleteDoc('${id}')" class="text-red-100 hover:text-red-500"><i data-lucide="trash-2" size="16"></i></button></div></div>`;
                      } else {
                          maintData.push({id, ...d});
                          totalProfit -= d.amount;
                          mList.innerHTML += `<div class="bg-amber-50 p-4 rounded-2xl border border-amber-100 flex justify-between items-center"><div class="text-right"><p class="font-bold">${d.detail}</p><p class="text-[9px] text-amber-600">${d.date}</p></div><div class="flex items-center gap-3"><p class="font-black text-amber-700">- ${d.amount}</p><button onclick="deleteDoc('${id}')" class="text-amber-200"><i data-lucide="x-circle" size="16"></i></button></div></div>`;
                      }
                  });
                  document.getElementById('total-profit').innerText = totalProfit.toLocaleString();
                  document.getElementById('share-m').innerText = "Rs. " + (totalProfit/2).toLocaleString();
                  document.getElementById('share-t').innerText = "Rs. " + (totalProfit/2).toLocaleString();
                  document.getElementById('stat-diesel').innerText = "Rs. " + totalDiesel.toLocaleString();
                  document.getElementById('stat-food').innerText = "Rs. " + totalFood.toLocaleString();
                  lucide.createIcons();
              });
        }

        async function deleteDoc(id) { if(confirm("Delete entry?")) await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('records').doc(id).delete(); }

        // PDF FIX FOR WEBVIEWER
        function downloadPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const btn = document.getElementById('pdf-btn');
            btn.innerText = "Generating...";

            doc.setFillColor(30, 64, 175); doc.rect(0, 0, 210, 40, 'F');
            doc.setTextColor(255, 255, 255); doc.setFontSize(22);
            doc.text("MK TRANSPORT REPORT", 105, 20, { align: "center" });
            
            const summaryBody = [[
                document.getElementById('total-profit').innerText,
                document.getElementById('stat-diesel').innerText,
                document.getElementById('stat-food').innerText,
                document.getElementById('share-m').innerText
            ]];

            doc.autoTable({
                startY: 50,
                head: [['Total Profit', 'Diesel', 'Food', 'Partner Share']],
                body: summaryBody,
                theme: 'grid', headStyles: { fillColor: [30, 64, 175] }
            });

            const tripRows = tripsData.map(t => [t.date, t.route, t.income, t.diesel, t.food, (t.income - (t.diesel + t.food))]);
            doc.autoTable({
                startY: doc.autoTable.previous.finalY + 15,
                head: [['Date', 'Route', 'Income', 'Diesel', 'Food', 'Net']],
                body: tripRows,
                theme: 'striped'
            });

            const maintRows = maintData.map(m => [m.date, m.detail, m.amount]);
            if(maintRows.length > 0) {
                doc.autoTable({
                    startY: doc.autoTable.previous.finalY + 15,
                    head: [['Date', 'Maintenance Detail', 'Cost']],
                    body: maintRows,
                    theme: 'striped', headStyles: { fillColor: [180, 83, 9] }
                });
            }

            // WebViewer Fix: Open in new window/tab if direct download fails
            try {
                const pdfData = doc.output('bloburl');
                window.open(pdfData, '_blank');
                btn.innerHTML = `<i data-lucide="file-text"></i> <span class="urdu text-lg">رپورٹ تیار کریں (PDF)</span>`;
                lucide.createIcons();
            } catch (e) {
                doc.save("MK_Report.pdf");
                btn.innerText = "Downloaded";
            }
        }

        document.getElementById('f-date').value = new Date().toISOString().split('T')[0];
    </script>
</body>
</html>

